---

title: process


keywords: fastai
sidebar: home_sidebar

summary: "Image processing submodule"
description: "Image processing submodule"
nb_path: "02_process.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 02_process.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">pylab</span> inline
<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Populating the interactive namespace from numpy and matplotlib
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">IPython</span> <span class="kn">import</span> <span class="n">display</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">requests</span> <span class="kn">import</span> <span class="n">session</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span><span class="p">,</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">zipfile</span> <span class="kn">import</span> <span class="n">ZipFile</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span><span class="p">,</span> <span class="n">Longitude</span><span class="p">,</span> <span class="n">Latitude</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.wcs</span> <span class="kn">import</span> <span class="n">WCS</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">simple_norm</span>
<span class="kn">from</span> <span class="nn">astroquery.vizier</span> <span class="kn">import</span> <span class="n">Vizier</span>
<span class="kn">from</span> <span class="nn">tqdm.auto</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.cmap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sqlitedict</span> <span class="kn">import</span> <span class="n">SqliteDict</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">photutils.detection</span> <span class="kn">import</span> <span class="n">DAOStarFinder</span>
<span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="kn">import</span> <span class="n">sigma_clipped_stats</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">make_lupton_rgb</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">astroalign</span> <span class="k">as</span> <span class="nn">aa</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~/.config/telescope.ini&#39;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[&#39;/home/jochym/.config/telescope.ini&#39;]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">OSO</span><span class="o">=</span><span class="n">Telescope</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;telescope.org&#39;</span><span class="p">][</span><span class="s1">&#39;user&#39;</span><span class="p">],</span> 
              <span class="n">config</span><span class="p">[</span><span class="s1">&#39;telescope.org&#39;</span><span class="p">][</span><span class="s1">&#39;password&#39;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ast</span> <span class="o">=</span> <span class="n">AstrometryNet</span><span class="p">()</span>
<span class="n">ast</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;astrometry.net&#39;</span><span class="p">][</span><span class="s1">&#39;apikey&#39;</span><span class="p">]</span>
<span class="n">solver</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;astrometry.net&#39;</span><span class="p">][</span><span class="s1">&#39;apikey&#39;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

<span class="n">Job</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Job&#39;</span><span class="p">,</span> <span class="s1">&#39;jid rid done&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">DB</span> <span class="o">=</span> <span class="n">SqliteDict</span><span class="p">(</span><span class="s1">&#39;telescope.sqlite&#39;</span><span class="p">,</span> <span class="n">autocommit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">VS</span> <span class="o">=</span> <span class="n">SqliteDict</span><span class="p">(</span><span class="s1">&#39;vstars.sqlite&#39;</span><span class="p">,</span> <span class="n">autocommit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">make_color_image</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="n">black</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">mults</span><span class="o">=</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)):</span>
    <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="o">*</span><span class="n">l</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mults</span><span class="p">,</span><span class="n">layers</span><span class="p">))</span>
    
    <span class="k">try</span> <span class="p">:</span>
        <span class="n">r_r</span><span class="p">,</span> <span class="n">r_f</span> <span class="o">=</span> <span class="n">aa</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">detection_sigma</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="n">r_r</span> <span class="o">=</span> <span class="n">r</span>
        
    <span class="k">try</span> <span class="p">:</span>
        <span class="n">b_r</span><span class="p">,</span> <span class="n">b_f</span> <span class="o">=</span> <span class="n">aa</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">detection_sigma</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="n">b_r</span> <span class="o">=</span> <span class="n">b</span>
        
    <span class="n">minlev</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">make_lupton_rgb</span><span class="p">(</span><span class="mf">0.9</span><span class="o">*</span><span class="n">r_r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b_r</span><span class="p">,</span> <span class="n">minimum</span><span class="o">=</span><span class="n">black</span><span class="o">*</span><span class="n">minlev</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="n">Q</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="n">stretch</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">process_job</span><span class="p">(</span><span class="n">jid</span><span class="p">):</span>
    <span class="n">job</span> <span class="o">=</span> <span class="n">OSO</span><span class="o">.</span><span class="n">get_job</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
    <span class="n">ctime</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;completion&#39;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;jid </span><span class="si">{</span><span class="n">jid</span><span class="si">}</span><span class="s1">: (&#39;</span><span class="p">,</span> <span class="n">OSO</span><span class="o">.</span><span class="n">get_request</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;rid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]))[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="sa">f</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ctime</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">OSO</span><span class="o">.</span><span class="n">get_obs</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">cube</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    <span class="n">hdul</span><span class="o">=</span><span class="p">[</span><span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">name</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">z</span><span class="o">.</span><span class="n">namelist</span><span class="p">()]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Filters: </span><span class="si">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;FILTER&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">hdu</span> <span class="ow">in</span> <span class="n">hdul</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">DB</span> <span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done&#39;</span><span class="p">)</span>
        <span class="n">display</span><span class="o">.</span><span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
        <span class="k">return</span>
    <span class="n">hi</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">hdul</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">wcs_head</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">hdul</span><span class="p">[</span><span class="n">hi</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">wcs_head</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot solve image&#39;</span><span class="p">)</span>
        <span class="n">OSO</span><span class="o">.</span><span class="n">get_obs</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">cube</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="n">hi</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">32</span><span class="p">,:</span><span class="o">-</span><span class="mi">32</span><span class="p">]</span>
        <span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">simple_norm</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;asinh&#39;</span><span class="p">,</span> <span class="n">asinh_a</span><span class="o">=</span><span class="mf">0.01</span><span class="p">))</span>
        <span class="n">show</span><span class="p">();</span>
        <span class="k">return</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">wcs_head</span><span class="p">)</span>
    <span class="n">box</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">calc_footprint</span><span class="p">()</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">box</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">Vizier</span><span class="o">.</span><span class="n">query_region</span><span class="p">(</span><span class="n">catalog</span><span class="o">=</span><span class="s1">&#39;B/gcvs&#39;</span><span class="p">,</span> 
                                 <span class="n">coordinates</span><span class="o">=</span><span class="n">SkyCoord</span><span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;fk5&#39;</span><span class="p">),</span> 
                                 <span class="n">width</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">deg&#39;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">deg&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;Name&#39;</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;GCVS&#39;</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;GCVS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
            <span class="k">elif</span> <span class="s1">&#39;NSV&#39;</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;NSV_</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="s2">&quot;NSV&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>

            <span class="c1">#print(f&#39;{name:12} {o[&quot;magMax&quot;]:6.2f} {o.keys()}&#39;)</span>
<span class="c1">#             print(f&#39;{name:12} {o[&quot;magMax&quot;]:6.2f}&#39;)</span>
    <span class="n">subplot</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    <span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">gca</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="c1">#print(g)</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;Name&#39;</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;GCVS&#39;</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;GCVS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
            <span class="k">elif</span> <span class="s1">&#39;NSV&#39;</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;NSV_</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="s2">&quot;NSV&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;VS_</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">try</span> <span class="p">:</span> 
                <span class="k">try</span> <span class="p">:</span>
                    <span class="n">radec</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;RAJ2000&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;DEJ2000&#39;</span><span class="p">],</span> 
                                     <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;fk5&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">radec</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;RAJ2000&#39;</span><span class="p">],</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;DEJ2000&#39;</span><span class="p">],</span> 
                                     <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;fk5&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">radec</span> <span class="o">=</span>  <span class="n">SkyCoord</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;_RA.icrs&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;_DE.icrs&#39;</span><span class="p">],</span> 
                                     <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;icrs&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
<span class="c1">#                     radec =  SkyCoord(o[&#39;RAB1950&#39;] + o[&#39;DEB1950&#39;], </span>
<span class="c1">#                                      frame=&#39;fk4&#39;, unit=(u.hourangle, u.deg))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">radec</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">radec</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="s1">&#39;icrs&#39;</span><span class="p">),</span> 
                       <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
<span class="c1">#             ax.text(radec.ra.deg, radec.dec.deg, f&#39;  {name} ({o[&quot;magMax&quot;]})&#39;, </span>
<span class="c1">#                     transform=ax.get_transform(&#39;fk5&#39;), color=&#39;red&#39;)</span>
    <span class="n">display</span><span class="o">.</span><span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;jid </span><span class="si">{</span><span class="n">jid</span><span class="si">}</span><span class="s1">: (&#39;</span><span class="p">,</span> <span class="n">OSO</span><span class="o">.</span><span class="n">get_request</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;rid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]))[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="sa">f</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ctime</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Filters: </span><span class="si">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;FILTER&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">hdu</span> <span class="ow">in</span> <span class="n">hdul</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">try</span> <span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hdul</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">imshow</span><span class="p">(</span><span class="n">make_color_image</span><span class="p">([</span><span class="n">hdu</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">32</span><span class="p">,:</span><span class="o">-</span><span class="mi">32</span><span class="p">]</span> <span class="k">for</span> <span class="n">hdu</span> <span class="ow">in</span> <span class="n">hdul</span><span class="p">]))</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="n">hi</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">32</span><span class="p">,:</span><span class="o">-</span><span class="mi">32</span><span class="p">]</span>
            <span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">simple_norm</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;asinh&#39;</span><span class="p">,</span> <span class="n">asinh_a</span><span class="o">=</span><span class="mf">0.01</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">aa</span><span class="o">.</span><span class="n">MaxIterError</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="n">hi</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">32</span><span class="p">,:</span><span class="o">-</span><span class="mi">32</span><span class="p">]</span>
        <span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">simple_norm</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;asinh&#39;</span><span class="p">,</span> <span class="n">asinh_a</span><span class="o">=</span><span class="mf">0.01</span><span class="p">))</span>
    <span class="n">DB</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span><span class="o">=</span><span class="n">Job</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">rid</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;rid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()],</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">show</span><span class="p">()</span>
    <span class="n">display</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">gcf</span><span class="p">());</span>    
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">reqlst</span><span class="o">=</span><span class="n">OSO</span><span class="o">.</span><span class="n">get_user_requests</span><span class="p">(</span><span class="n">sort</span><span class="o">=</span><span class="s1">&#39;completion&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of users requests: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">reqlst</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">complete</span> <span class="o">=</span> <span class="p">[</span><span class="n">rq</span> <span class="k">for</span> <span class="n">rq</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">reqlst</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;requesttime&#39;</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
                    <span class="k">if</span> <span class="n">Telescope</span><span class="o">.</span><span class="n">REQUESTSTATUS_TEXTS</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">rq</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">])]</span><span class="o">==</span><span class="s1">&#39;Complete&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Completed:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">complete</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Number of users requests: 1189
Completed: 1168
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">figsize</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">complete</span><span class="p">:</span>
    <span class="n">process_job</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">OSO</span><span class="o">.</span><span class="n">get_request</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))[</span><span class="s1">&#39;jid&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>jid 337501: ( BI Her )
5 July 2019 00:50:48 UTC
Filters: (&#39;R&#39;, &#39;V&#39;, &#39;B&#39;)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="mi">1</span><span class="o">/</span><span class="mi">0</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
<span class="n">olst</span> <span class="o">=</span> <span class="n">OSO</span><span class="o">.</span><span class="n">get_obs_list</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> 
                                   <span class="n">now</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> 
                                   <span class="n">now</span><span class="o">.</span><span class="n">day</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> 
                                   <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Observations: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">olst</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">olst</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">solve_field_upload</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">crop</span><span class="o">=</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">32</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">32</span><span class="p">)),</span> <span class="n">cache</span><span class="o">=</span><span class="s1">&#39;.cache/wcs&#39;</span><span class="p">,</span> 
                       <span class="n">set_center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_solve</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">hdu</span><span class="o">.</span><span class="n">verify_datasum</span><span class="p">()</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">hdu</span><span class="o">.</span><span class="n">add_datasum</span><span class="p">()</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;DATASUM&quot;</span><span class="p">])</span><span class="si">:</span><span class="s1">08X</span><span class="si">}</span><span class="s1">.wcs&#39;</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span><span class="n">fn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">fn</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">force_solve</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Solving for &#39;</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>
        <span class="k">try</span> <span class="p">:</span>
            <span class="n">settings</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;scale_type&#39;</span><span class="p">:</span> <span class="s1">&#39;ul&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;scale_units&#39;</span><span class="p">:</span> <span class="s1">&#39;arcsecperpix&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;scale_lower&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
                        <span class="s1">&#39;scale_upper&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                       <span class="p">}</span>
            <span class="k">if</span> <span class="n">set_center</span> <span class="p">:</span>
                <span class="n">settings</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;center_ra&#39;</span><span class="p">:</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">15</span><span class="p">,</span>
                                 <span class="s1">&#39;center_dec&#39;</span><span class="p">:</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;DEC&#39;</span><span class="p">],</span>
                                 <span class="s1">&#39;radius&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> 
                                 <span class="s1">&#39;parity&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                <span class="p">})</span>

            <span class="n">wcs_header</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">solve_from_image</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">force_image_upload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">solve_timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">wcs_header</span> <span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Success&#39;</span><span class="p">)</span>
                <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;IMAGEW&#39;</span><span class="p">]</span>
                <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;IMAGEH&#39;</span><span class="p">]</span>
                <span class="k">try</span> <span class="p">:</span> 
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fp</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                        <span class="n">wcs_header</span><span class="o">.</span><span class="n">totextfile</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No solution&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ASTTimeoutError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Solver timeout&#39;</span><span class="p">)</span>
            <span class="n">wcs_header</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Getting </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s1"> from cache&#39;</span><span class="p">)</span>
        <span class="n">wcs_header</span><span class="o">=</span><span class="kc">None</span>
        <span class="kn">from</span> <span class="nn">astropy.io.fits</span> <span class="kn">import</span> <span class="n">Header</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">wcs_header</span> <span class="o">=</span> <span class="n">Header</span><span class="o">.</span><span class="n">fromtextfile</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wcs_header</span>    
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">solve_field_list</span><span class="p">(</span><span class="n">hdu</span><span class="p">,</span> <span class="n">crop</span><span class="o">=</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">32</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">32</span><span class="p">)),</span> <span class="n">cache</span><span class="o">=</span><span class="s1">&#39;.cache/wcs&#39;</span><span class="p">,</span> 
                <span class="n">set_center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_solve</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_upload</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">minsrc</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">maxsrc</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">hdu</span><span class="o">.</span><span class="n">verify_datasum</span><span class="p">()</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">hdu</span><span class="o">.</span><span class="n">add_datasum</span><span class="p">()</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;DATASUM&quot;</span><span class="p">])</span><span class="si">:</span><span class="s1">08X</span><span class="si">}</span><span class="s1">.wcs&#39;</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span><span class="n">fn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">fn</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">force_solve</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Solving for &#39;</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">crop</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">crop</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">crop</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">crop</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">mean</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="p">:</span>
            <span class="n">daofind</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">fwhm</span><span class="o">=</span><span class="mf">8.0</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">sigma</span><span class="o">*</span><span class="n">std</span><span class="p">)</span>
            <span class="n">sources</span> <span class="o">=</span> <span class="n">daofind</span><span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">median</span><span class="p">)</span>
            <span class="c1">#print(sigma, sources)</span>
            <span class="k">if</span> <span class="n">sources</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">minsrc</span><span class="p">:</span>
                <span class="n">sigma</span> <span class="o">/=</span> <span class="mi">2</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxsrc</span><span class="p">:</span>
                <span class="n">sigma</span> <span class="o">*=</span> <span class="mi">2</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cannot extract </span><span class="si">{</span><span class="n">minsrc</span><span class="si">}</span><span class="s1"> &lt; n &lt; </span><span class="si">{</span><span class="n">maxsrc</span><span class="si">}</span><span class="s1"> sources.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>


        <span class="n">sources</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">)</span>
        <span class="n">sources</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>


        <span class="k">try</span> <span class="p">:</span>
            <span class="n">settings</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;scale_type&#39;</span><span class="p">:</span> <span class="s1">&#39;ul&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;scale_units&#39;</span><span class="p">:</span> <span class="s1">&#39;arcsecperpix&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;scale_lower&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
                        <span class="s1">&#39;scale_upper&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                       <span class="p">}</span>
            <span class="k">if</span> <span class="n">set_center</span> <span class="p">:</span>
                <span class="n">settings</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;center_ra&#39;</span><span class="p">:</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">15</span><span class="p">,</span>
                                 <span class="s1">&#39;center_dec&#39;</span><span class="p">:</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;DEC&#39;</span><span class="p">],</span>
                                 <span class="s1">&#39;radius&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> 
                                 <span class="s1">&#39;parity&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                <span class="p">})</span>

            <span class="n">wcs_header</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">solve_from_source_list</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">],</span> 
                                                    <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                    <span class="n">solve_timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
                                                    <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">wcs_header</span> <span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Success&#39;</span><span class="p">)</span>
                <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;IMAGEW&#39;</span><span class="p">]</span>
                <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;IMAGEH&#39;</span><span class="p">]</span>
                <span class="k">try</span> <span class="p">:</span> 
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fp</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                        <span class="n">wcs_header</span><span class="o">.</span><span class="n">totextfile</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">No solution&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ASTTimeoutError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Solver timeout&#39;</span><span class="p">)</span>
            <span class="n">wcs_header</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Getting </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s1"> from cache&#39;</span><span class="p">)</span>
        <span class="n">wcs_header</span><span class="o">=</span><span class="kc">None</span>
        <span class="kn">from</span> <span class="nn">astropy.io.fits</span> <span class="kn">import</span> <span class="n">Header</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">wcs_header</span> <span class="o">=</span> <span class="n">Header</span><span class="o">.</span><span class="n">fromtextfile</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wcs_header</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">OSO</span><span class="o">.</span><span class="n">get_job</span><span class="p">(</span><span class="n">olst</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">figsize</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="k">for</span> <span class="n">nj</span><span class="p">,</span> <span class="n">jid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">olst</span><span class="p">):</span>
    <span class="c1">#jid = int(OSO.get_request(int(rq[&#39;id&#39;]))[&#39;jid&#39;][1:])</span>
    <span class="n">job</span> <span class="o">=</span> <span class="n">OSO</span><span class="o">.</span><span class="n">get_job</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
    <span class="n">ctime</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;completion&#39;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">nj</span><span class="si">}</span><span class="s1">:jid </span><span class="si">{</span><span class="n">jid</span><span class="si">}</span><span class="s1"> (&#39;</span><span class="p">,</span> <span class="n">OSO</span><span class="o">.</span><span class="n">get_request</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;rid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]))[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="sa">f</span><span class="s1">&#39;):  </span><span class="si">{</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ctime</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">OSO</span><span class="o">.</span><span class="n">get_obs</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">cube</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    <span class="n">hdul</span><span class="o">=</span><span class="p">[</span><span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">name</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">z</span><span class="o">.</span><span class="n">namelist</span><span class="p">()]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Filters: </span><span class="si">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;FILTER&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">hdu</span> <span class="ow">in</span> <span class="n">hdul</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">DB</span> <span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done&#39;</span><span class="p">)</span>
        <span class="n">display</span><span class="o">.</span><span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
        <span class="k">continue</span>
    <span class="n">hi</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">hdul</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">try</span> <span class="p">:</span>
        <span class="n">wcs_head</span> <span class="o">=</span> <span class="n">solve_field_list</span><span class="p">(</span><span class="n">hdul</span><span class="p">[</span><span class="n">hi</span><span class="p">])</span>
    <span class="k">except</span> <span class="n">ASTTimeoutError</span><span class="p">:</span>
        <span class="n">wcs_head</span> <span class="o">=</span> <span class="kc">None</span>
<span class="c1">#    wcs_head = None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">wcs_head</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">OSO</span><span class="o">.</span><span class="n">get_obs</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">cube</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">wcs_head</span> <span class="o">=</span> <span class="n">solve_field_upload</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ASTTimeoutError</span><span class="p">:</span>
            <span class="n">wcs_head</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">wcs_head</span><span class="p">:</span>
        <span class="k">try</span> <span class="p">:</span>
            <span class="n">wcs_head</span> <span class="o">=</span> <span class="n">solve_field_list</span><span class="p">(</span><span class="n">hdul</span><span class="p">[</span><span class="n">hi</span><span class="p">],</span> <span class="n">set_center</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ASTTimeoutError</span><span class="p">:</span>
            <span class="n">wcs_head</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">wcs_head</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">OSO</span><span class="o">.</span><span class="n">get_obs</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">cube</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">wcs_head</span> <span class="o">=</span> <span class="n">solve_field_upload</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">set_center</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ASTTimeoutError</span><span class="p">:</span>
            <span class="n">wcs_head</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">wcs_head</span> <span class="p">:</span>
        <span class="n">hdul</span><span class="p">[</span><span class="n">hi</span><span class="p">]</span><span class="o">.</span><span class="n">add_datasum</span><span class="p">()</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">hdul</span><span class="p">[</span><span class="n">hi</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;DATASUM&quot;</span><span class="p">])</span><span class="si">:</span><span class="s1">08X</span><span class="si">}</span><span class="s1">.wcs&#39;</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;.cache/wcs&#39;</span><span class="p">,</span><span class="n">fn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">fn</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">try</span> <span class="p">:</span> 
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fp</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">wcs_head</span><span class="o">.</span><span class="n">totextfile</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">wcs_head</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot solve image&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="n">hi</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">32</span><span class="p">,:</span><span class="o">-</span><span class="mi">32</span><span class="p">]</span>
        <span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">simple_norm</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;asinh&#39;</span><span class="p">,</span> <span class="n">asinh_a</span><span class="o">=</span><span class="mf">0.01</span><span class="p">))</span>
        <span class="n">show</span><span class="p">();</span>
        <span class="k">continue</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">wcs_head</span><span class="p">)</span>
    <span class="n">box</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">calc_footprint</span><span class="p">()</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">box</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">Vizier</span><span class="o">.</span><span class="n">query_region</span><span class="p">(</span><span class="n">catalog</span><span class="o">=</span><span class="s1">&#39;B/gcvs&#39;</span><span class="p">,</span> 
                                 <span class="n">coordinates</span><span class="o">=</span><span class="n">SkyCoord</span><span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;fk5&#39;</span><span class="p">),</span> 
                                 <span class="n">width</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">deg&#39;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">deg&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;Name&#39;</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;GCVS&#39;</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;GCVS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
            <span class="k">elif</span> <span class="s1">&#39;NSV&#39;</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;NSV_</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="s2">&quot;NSV&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>

            <span class="c1">#print(f&#39;{name:12} {o[&quot;magMax&quot;]:6.2f} {o.keys()}&#39;)</span>
<span class="c1">#             print(f&#39;{name:12} {o[&quot;magMax&quot;]:6.2f}&#39;)</span>
    <span class="n">subplot</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    <span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">gca</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="c1">#print(g)</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;Name&#39;</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;GCVS&#39;</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;GCVS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
            <span class="k">elif</span> <span class="s1">&#39;NSV&#39;</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;NSV_</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="s2">&quot;NSV&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;VS_</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">try</span> <span class="p">:</span> 
                <span class="k">try</span> <span class="p">:</span>
                    <span class="n">radec</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;RAJ2000&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;DEJ2000&#39;</span><span class="p">],</span> 
                                     <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;fk5&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">radec</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;RAJ2000&#39;</span><span class="p">],</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;DEJ2000&#39;</span><span class="p">],</span> 
                                     <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;fk5&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">radec</span> <span class="o">=</span>  <span class="n">SkyCoord</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;_RA.icrs&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;_DE.icrs&#39;</span><span class="p">],</span> 
                                     <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;icrs&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
<span class="c1">#                     radec =  SkyCoord(o[&#39;RAB1950&#39;] + o[&#39;DEB1950&#39;], </span>
<span class="c1">#                                      frame=&#39;fk4&#39;, unit=(u.hourangle, u.deg))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">radec</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">radec</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="s1">&#39;icrs&#39;</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
<span class="c1">#             ax.text(radec.ra.deg, radec.dec.deg, f&#39;  {name} ({o[&quot;magMax&quot;]})&#39;, </span>
<span class="c1">#                     transform=ax.get_transform(&#39;fk5&#39;), color=&#39;red&#39;)</span>
    <span class="n">display</span><span class="o">.</span><span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">nj</span><span class="si">}</span><span class="s1">:jid </span><span class="si">{</span><span class="n">jid</span><span class="si">}</span><span class="s1"> (&#39;</span><span class="p">,</span> <span class="n">OSO</span><span class="o">.</span><span class="n">get_request</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;rid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]))[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="sa">f</span><span class="s1">&#39;):  </span><span class="si">{</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ctime</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Filters: </span><span class="si">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;FILTER&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">hdu</span> <span class="ow">in</span> <span class="n">hdul</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">try</span> <span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hdul</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">imshow</span><span class="p">(</span><span class="n">make_color_image</span><span class="p">([</span><span class="n">hdu</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">32</span><span class="p">,:</span><span class="o">-</span><span class="mi">32</span><span class="p">]</span> <span class="k">for</span> <span class="n">hdu</span> <span class="ow">in</span> <span class="n">hdul</span><span class="p">]))</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="n">hi</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">32</span><span class="p">,:</span><span class="o">-</span><span class="mi">32</span><span class="p">]</span>
            <span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">simple_norm</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;asinh&#39;</span><span class="p">,</span> <span class="n">asinh_a</span><span class="o">=</span><span class="mf">0.01</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">aa</span><span class="o">.</span><span class="n">MaxIterError</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="n">hi</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">32</span><span class="p">,:</span><span class="o">-</span><span class="mi">32</span><span class="p">]</span>
        <span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">simple_norm</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;asinh&#39;</span><span class="p">,</span> <span class="n">asinh_a</span><span class="o">=</span><span class="mf">0.01</span><span class="p">))</span>
    <span class="n">DB</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span><span class="o">=</span><span class="n">Job</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">rid</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;rid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()],</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">show</span><span class="p">()</span>
    <span class="n">display</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">gcf</span><span class="p">());</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">jid</span> <span class="o">=</span> <span class="mi">383576</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">OSO</span><span class="o">.</span><span class="n">get_obs</span><span class="p">(</span><span class="n">OSO</span><span class="o">.</span><span class="n">get_job</span><span class="p">(</span><span class="n">jid</span><span class="p">),</span> <span class="n">cube</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">solve_field_upload</span><span class="p">(</span><span class="n">img</span><span class="p">);</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">rq</span> <span class="o">=</span> <span class="n">complete</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">jid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">OSO</span><span class="o">.</span><span class="n">get_request</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">rq</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))[</span><span class="s1">&#39;jid&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">jid</span> <span class="o">=</span> <span class="mi">383310</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">OSO</span><span class="o">.</span><span class="n">get_obs</span><span class="p">(</span><span class="n">OSO</span><span class="o">.</span><span class="n">get_job</span><span class="p">(</span><span class="n">jid</span><span class="p">),</span> <span class="n">cube</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">OSO</span><span class="o">.</span><span class="n">get_obs</span><span class="p">(</span><span class="n">OSO</span><span class="o">.</span><span class="n">get_job</span><span class="p">(</span><span class="n">jid</span><span class="p">),</span> <span class="n">cube</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">solve_field_upload</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">hdul</span><span class="o">.</span><span class="n">fileinfo</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">hdul</span><span class="o">=</span><span class="p">[</span><span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">name</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">z</span><span class="o">.</span><span class="n">namelist</span><span class="p">()]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">hdu</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">hdu</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hdul</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;FILTER&#39;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">w</span> <span class="o">=</span> <span class="n">solve_field</span><span class="p">(</span><span class="n">hdu</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">32</span><span class="p">,:</span><span class="o">-</span><span class="mi">32</span><span class="p">]</span> <span class="k">for</span> <span class="n">hdu</span> <span class="ow">in</span> <span class="n">hdul</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">subplot</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">WCS</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
<span class="n">imshow</span><span class="p">(</span><span class="n">make_color_image</span><span class="p">([</span><span class="n">hdu</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">32</span><span class="p">,:</span><span class="o">-</span><span class="mi">32</span><span class="p">]</span> <span class="k">for</span> <span class="n">hdu</span> <span class="ow">in</span> <span class="n">hdul</span><span class="p">],</span>
                        <span class="n">black</span><span class="o">=</span><span class="mf">1.15</span><span class="p">,</span>
                        <span class="n">stretch</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                        <span class="n">Q</span><span class="o">=</span><span class="mi">5</span>
                       <span class="p">))</span>
<span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">imshow</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">simple_norm</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;asinh&#39;</span><span class="p">,</span> <span class="n">asinh_a</span><span class="o">=</span><span class="mf">0.1</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;DATASUM&quot;</span><span class="p">])</span><span class="si">:</span><span class="s1">08X</span><span class="si">}</span><span class="s1">&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">aa</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">detection_sigma</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">32</span><span class="p">,:</span><span class="o">-</span><span class="mi">32</span><span class="p">]</span>
<span class="n">mean</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
<span class="n">norm</span><span class="o">=</span><span class="n">simple_norm</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;asinh&#39;</span><span class="p">,</span> <span class="n">asinh_a</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">daofind</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">fwhm</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">200.</span><span class="o">*</span><span class="n">std</span><span class="p">)</span>
<span class="n">sources</span> <span class="o">=</span> <span class="n">daofind</span><span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">median</span><span class="p">)</span>
<span class="n">sources</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">)</span>
<span class="n">sources</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
<span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">figsize</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">photutils.aperture</span> <span class="kn">import</span> <span class="n">CircularAperture</span>
<span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]))</span>
<span class="n">apertures</span> <span class="o">=</span> <span class="n">CircularAperture</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mf">5.</span><span class="p">)</span>
<span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
<span class="n">apertures</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">);</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">2</span>
<span class="n">wcs</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">wcs_header</span><span class="p">)</span>
<span class="n">box</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">calc_footprint</span><span class="p">(</span><span class="n">wcs_header</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">box</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cats</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;B/gcvs&#39;</span><span class="p">,</span> <span class="s1">&#39;B/vsx&#39;</span><span class="p">]</span>
<span class="n">cats</span> <span class="o">=</span> <span class="s1">&#39;B/gcvs&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">Vizier</span><span class="o">.</span><span class="n">query_region</span><span class="p">(</span><span class="n">catalog</span><span class="o">=</span><span class="n">cats</span><span class="p">,</span> <span class="n">coordinates</span><span class="o">=</span><span class="n">SkyCoord</span><span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;fk5&#39;</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">deg&#39;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">deg&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;Name&#39;</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;GCVS&#39;</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;GCVS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
        <span class="k">elif</span> <span class="s1">&#39;NSV&#39;</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;NSV_</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="s2">&quot;NSV&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="s1">12</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="s2">&quot;magMax&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">6.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">figsize</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">14</span><span class="p">)</span>
<span class="n">subplot</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">wcs</span><span class="p">)</span>
<span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
<span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">gca</span><span class="p">()</span>
<span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;Name&#39;</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;GCVS&#39;</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;GCVS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
        <span class="k">elif</span> <span class="s1">&#39;NSV&#39;</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;NSV_</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="s2">&quot;NSV&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;VS_</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">try</span> <span class="p">:</span>
            <span class="n">radec</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;RAJ2000&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;DEJ2000&#39;</span><span class="p">],</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;fk5&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">radec</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;RAJ2000&#39;</span><span class="p">],</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;DEJ2000&#39;</span><span class="p">],</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;fk5&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">radec</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">radec</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="s1">&#39;icrs&#39;</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">radec</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">radec</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;  </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">o</span><span class="p">[</span><span class="s2">&quot;magMax&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> 
                <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="s1">&#39;fk5&#39;</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
    
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">figsize</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
<span class="n">imshow</span><span class="p">((</span><span class="n">data</span><span class="p">),</span><span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">simple_norm</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;asinh&#39;</span><span class="p">,</span> <span class="n">asinh_a</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">imshow</span><span class="p">(</span><span class="n">make_color_image</span><span class="p">([</span><span class="n">hdu</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">100</span><span class="p">,:</span><span class="o">-</span><span class="mi">100</span><span class="p">]</span> <span class="k">for</span> <span class="n">hdu</span> <span class="ow">in</span> <span class="n">hdul</span><span class="p">]))</span>
<span class="c1">#grid(color=&#39;white&#39;, ls=&#39;solid&#39;)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">searchVS</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">cat</span><span class="o">=</span><span class="s1">&#39;GCVS&#39;</span><span class="p">,</span> <span class="n">caturl</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxSearchRadius</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Search the area of the image in h (hdu, fits) for variable stars</span>
<span class="sd">    using the given catalogue. The cat imput parameter denotes the </span>
<span class="sd">    catalogue:</span>
<span class="sd">    </span>
<span class="sd">    &#39;GCVS&#39; - use the General Catalogue of Variable Stars</span>
<span class="sd">    &#39;VSX&#39;  - use the AAVSO Variable Star Index</span>
<span class="sd">    &#39;USER&#39; - use the custom url passed in caturl parameter</span>
<span class="sd">    </span>
<span class="sd">    The maximum search radius is specified by maxSearchRadius (deg).</span>
<span class="sd">    </span>
<span class="sd">    Returns a list of VS in the circle with the frame inscribed in it.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">pyvo</span> <span class="kn">import</span> <span class="n">conesearch</span>
    
    <span class="k">if</span> <span class="n">cat</span><span class="o">==</span><span class="s1">&#39;GCVS&#39;</span> <span class="p">:</span>
        <span class="n">caturl</span><span class="o">=</span><span class="s1">&#39;http://vizier.u-strasbg.fr/viz-bin/votable/-A?-source=B/vsx&amp;amp;&#39;</span>
    <span class="k">elif</span> <span class="n">cat</span><span class="o">==</span><span class="s1">&#39;VSX&#39;</span> <span class="p">:</span>
        <span class="n">caturl</span><span class="o">=</span><span class="s1">&#39;http://heasarc.gsfc.nasa.gov/cgi-bin/vo/cone/coneGet.pl?table=aavsovsx&amp;amp;&#39;</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="n">caturl</span><span class="o">=</span><span class="n">caturl</span>
    
    <span class="n">w</span><span class="o">=</span><span class="n">WCS</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
    <span class="n">cen</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">all_pix2world</span><span class="p">(</span><span class="n">array</span><span class="p">([[</span><span class="n">h</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">],</span> <span class="n">h</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]]])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Half of the hypotenuse of the frame = radius of the search</span>
    <span class="n">rad</span><span class="o">=</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">real</span><span class="p">(</span><span class="n">eigvals</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cd</span><span class="p">))</span><span class="o">*</span><span class="n">array</span><span class="p">([</span><span class="n">h</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">],</span> <span class="n">h</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]]))</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
    <span class="c1"># Clamp to reasonable size</span>
    <span class="n">rad</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">maxSearchRadius</span><span class="p">)</span>
    <span class="n">r</span><span class="o">=</span><span class="n">conesearch</span><span class="p">(</span><span class="n">caturl</span><span class="p">,</span><span class="n">pos</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">cen</span><span class="p">),</span><span class="n">radius</span><span class="o">=</span><span class="n">rad</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">searchVS</span><span class="p">(</span><span class="n">wcs_header</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;IMAGEW&#39;</span><span class="p">]</span>
<span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;IMAGEH&#39;</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">analyseJob</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">cat</span><span class="o">=</span><span class="s1">&#39;GCVS&#39;</span><span class="p">):</span>
    <span class="n">obs</span><span class="o">=</span><span class="n">scope</span><span class="o">.</span><span class="n">get_job</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;SSBODY&#39;</span> <span class="p">:</span>
        <span class="nb">print</span> <span class="n">jid</span><span class="p">,</span> <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">],</span> <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;exp&#39;</span><span class="p">],</span> <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;oid&#39;</span><span class="p">]</span>
        
        <span class="n">z</span><span class="o">=</span><span class="n">scope</span><span class="o">.</span><span class="n">get_obs</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span><span class="n">cube</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="n">hdul</span><span class="o">=</span><span class="p">[</span><span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">z</span><span class="o">.</span><span class="n">namelist</span><span class="p">()]</span>

        <span class="k">for</span> <span class="n">h</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">hdul</span><span class="p">,</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]):</span>
            <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;FILTER&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">f</span>

        <span class="n">shdul</span><span class="o">=</span><span class="p">[</span><span class="n">scope</span><span class="o">.</span><span class="n">solveField</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">jid</span><span class="p">))</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hdul</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">h</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shdul</span><span class="p">):</span>
            <span class="nb">print</span> <span class="s1">&#39;Filter: &#39;</span><span class="p">,</span><span class="n">hdul</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;FILTER&#39;</span><span class="p">],</span>
            <span class="k">if</span> <span class="n">h</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
                <span class="nb">print</span> <span class="s1">&#39;Unable to solve the field!&#39;</span>
                <span class="n">imshow</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">hdul</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">),</span><span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">w</span><span class="o">=</span><span class="n">wcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
            <span class="n">imshow</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">),</span><span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
            <span class="n">plot</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;r+&#39;</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;RADEC&#39;</span><span class="p">:</span>
                <span class="n">obj</span><span class="o">=</span><span class="n">SkyCoord</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;oid&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">obj</span><span class="o">=</span><span class="n">SkyCoord</span><span class="o">.</span><span class="n">from_name</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;oid&#39;</span><span class="p">])</span>
            <span class="n">pix</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">all_world2pix</span><span class="p">(</span><span class="n">array</span><span class="p">([[</span><span class="n">obj</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span><span class="n">obj</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">deg</span><span class="p">]]),</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">plot</span><span class="p">(</span><span class="n">pix</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pix</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;r+&#39;</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">plot</span><span class="p">(</span><span class="n">pix</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pix</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;ro&#39;</span><span class="p">,</span><span class="n">fillstyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="n">r</span><span class="o">=</span><span class="n">searchVS</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;Number of VS:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                <span class="n">vsname</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(Name)-25s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">s</span>
                <span class="c1"># filter out NSV and VSX hits (leave just GCVS marked stars)</span>
                <span class="k">if</span> <span class="n">vsname</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;NSV&#39;</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">vsname</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;VSX&#39;</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span> <span class="p">:</span>
                    <span class="n">pix</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">all_world2pix</span><span class="p">(</span><span class="n">array</span><span class="p">([[</span><span class="n">s</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span><span class="n">s</span><span class="o">.</span><span class="n">dec</span><span class="p">]]),</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="c1"># reject out of frame stars</span>
                    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">pix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">pix</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span> <span class="p">:</span>
                        <span class="n">plot</span><span class="p">(</span><span class="n">pix</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pix</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;ro&#39;</span><span class="p">,</span><span class="n">fillstyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
                        <span class="n">annotate</span><span class="p">(</span><span class="n">vsname</span><span class="p">,</span> <span class="n">pix</span><span class="p">,</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="o">-</span><span class="mi">7</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
                        <span class="nb">print</span> <span class="s1">&#39;</span><span class="si">%(Name)25s</span><span class="s1"> </span><span class="si">%(Period)12.6f</span><span class="s1"> </span><span class="si">%(min)6.2f</span><span class="s1"> - </span><span class="si">%(max)6.2f</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">s</span>
            <span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">])</span>
            <span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">])</span>
            <span class="n">show</span><span class="p">()</span>
        <span class="nb">print</span>
    
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

